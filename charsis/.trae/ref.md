# 项目参考文档

## 项目概述
这是一个针对刻本图片文字进行处理和分析的项目，主要使用 Python 进行开发。

## 项目结构
```
charsis/
├── src/
│   ├── config.py      # 全局配置文件
│   ├── preprocess/    # 图像预处理模块
│   ├── segmentation/  # 字符分割模块
│   ├── ocr/          # OCR识别模块
│   ├── analysis/     # 数据分析模块
│   └── utils/        # 工具函数
├── data/
│   └── raw/          # 原始图片数据
├── notebooks/        # Jupyter笔记本
└── tests/           # 测试文件
```

## 开发阶段

### 第一阶段：基础功能实现 ✅
- [x] 项目结构搭建
- [x] 图像预处理模块
- [x] 字符分割核心算法
- [x] 字符合并策略

### 第二阶段：参数配置化 ✅
- [x] 将硬编码参数移至配置文件
- [x] 统一参数管理
- [x] 提高代码可维护性

### 第三阶段：代码重构优化 ✅
- [x] segmentation模块化重构
- [x] 代码结构优化
- [x] 功能模块分离

### 第四阶段：待开发功能 ⏳
- [ ] OCR识别功能
- [ ] 数据分析功能

## 当前进展
- 完成了基础的图像预处理功能
- 实现了字符分割和合并算法
- 完成了参数配置化重构，将8个模块的硬编码参数移至config.py统一管理
- **完成了segmentation模块的重构优化**

### segmentation模块重构成果
将原本冗长混乱的单文件重构为清晰的模块化结构：

#### 新的模块结构
- **`detection.py`**: 字符类型检测和尺寸分析
  - `analyze_character_dimensions()`: 字符尺寸统计分析
  - `detect_vertically_connected_chars()`: 纵向连接字符检测
  - `detect_wide_chars()`: 过宽字符检测
  - `reclassify_split_character()`: 字符重分类

- **`projection.py`**: 投影分析和字符分割
  - `horizontal_projection_split_vertical_chars()`: 水平投影分割纵向字符
  - `vertical_projection_split_wide_chars()`: 垂直投影分割过宽字符
  - 辅助函数：投影平滑、分割区域查找、智能均匀分割

- **`merger.py`**: 字符合并处理
  - `calculate_robust_dimensions()`: 鲁棒尺寸计算
  - `classify_characters()`: 字符初始分类
  - `red_red_merge()`: 红红合并策略
  - `red_green_merge()`: 红绿合并策略
  - `merge_narrow_characters()`: 窄字符合并主函数

- **`visualization.py`**: 可视化和结果输出
  - `annotate_characters()`: 字符分类标注
  - `save_annotated_image()`: 保存标注图像
  - `print_classification_stats()`: 打印统计信息
  - `create_legend_image()`: 创建图例

- **`core.py`**: 主控制模块
  - `segment_characters()`: 字符分割主函数
  - `process_all_preprocessed_images()`: 批量处理函数

#### 重构优势
1. **模块化设计**: 功能清晰分离，便于维护和扩展
2. **代码复用**: 各模块可独立使用和测试
3. **可读性提升**: 代码结构清晰，逻辑易懂
4. **配置统一**: 所有参数从config.py统一管理
5. **错误处理**: 改进了错误处理和边界情况处理

测试结果显示重构后的代码功能完全正常，性能与重构前保持一致。

## 配置化重构详情
已将以下模块的参数进行配置化：
- IQR异常值检测参数
- 纵向连接字符检测参数
- 过宽字符检测参数
- 字符重分类参数
- 投影分析参数
- 红红合并参数
- 红绿合并参数
- 字符分类参数（包括二值化、膨胀等图像处理参数）

所有参数现在都可以通过修改src/config.py文件进行调整，提高了代码的可维护性和灵活性。

## 开发计划

1.  **图像预处理 (`src/preprocess`)**: ✅ 已完成基础功能 - 实现图像的灰度化、CLAHE局部对比度增强、线性变换调整全局对比度和亮度。
2.  **文字切割 (`src/segmentation`)**: ✅ 已完成增强功能 - 使用形态学方法进行字符切割，支持字符宽度分析、纵向连接字符检测和智能分类标注。
3.  **OCR识别 (`src/ocr`)**: 对切割后的单字图片进行文字识别。
4.  **数据分析 (`src/analysis`)**: 对识别结果进行统计和分析。

## 当前进展

### 已完成
- ✅ 项目结构重构：统一使用 `data/` 目录管理所有数据文件
- ✅ 图像预处理模块：`src/preprocess/core.py` 已适配新的项目结构
- ✅ 文字切割模块：`src/segmentation/core.py` 实现投影分析字符切割
- ✅ 可视化工具：`src/segmentation/visualizer.py` 用于显示切割结果
- ✅ 配置管理：`src/config.py` 提供统一的路径配置
- ✅ 工具函数：`src/utils/path.py` 提供路径管理辅助功能

### 文字切割模块 (src/segmentation/core.py)

**最新状态**: 已实现完整的字符分割、重新分类和红色字符合并系统

- ✅ 多轮合并策略已成功实现并优化
- ✅ 红红合并支持多轮迭代，彻底处理相邻红色字符
- ✅ 红绿合并在红红合并完成后进行，避免颜色信息丢失
- ✅ 使用众数作为尺寸参考，提高合并判断的准确性

**核心功能**:
1. **智能字符分类**:
   - 红色框：较窄字符（宽度 < 平均宽度 - 标准差）
   - 绿色框：正常字符
   - 蓝色框：过宽字符（宽度 ≥ 平均宽度的1.5倍，高度合理，宽高比 ≤ 6.0）
   - 紫色框：纵向连接字符（高度 ≥ 平均高度的1.5倍，高宽比 > 2.5，宽度合理）

2. **投影分析切割算法**:
   - **紫色字符（纵向连接）**: 使用水平投影分析法
     - 统计每行白色像素数量，寻找字符间空隙
     - 智能聚类分割点，确保分割准确性
     - 验证分割后字符的合理高度
   - **蓝色字符（过宽）**: 使用垂直投影分析法
     - 统计每列白色像素数量，寻找字符间空隙
     - 智能聚类分割点，确保分割准确性
     - 验证分割后字符的合理宽度

3. **红色字符合并算法**:
   - **多轮合并策略优化**: 红红合并（多轮） → 红绿合并
   - **第一阶段：多轮红红合并**
     - 水平距离 ≤ 众数宽度 × 0.3，垂直重叠 > 50%
     - 合并后尺寸验证：宽度0.5-2.5倍众数宽度，高度0.5-3.0倍众数高度
     - 每轮合并后重新分类字符，继续下一轮直到无新合并发生
   - **第二阶段：红绿合并**
     - 水平距离 ≤ 众数宽度 × 1.0，垂直重叠 > 20%
     - 合并后尺寸验证：宽度0.5-3.5倍众数宽度，高度0.4-3.5倍众数高度
   - **尺寸参考优化**: 使用众数（mode）替代平均值作为典型尺寸参考

4. **切割后重新分类**:
   - 对所有分割后的字符重新进行尺寸分析
   - 根据新的宽度比例重新分类为红色/绿色/蓝色
   - 确保分割结果的准确性和一致性

5. **可视化标注**:
   - 原始框：虚线标注（紫色/蓝色）
   - 分割后框：实线标注，颜色根据重新分类结果确定
   - 合并字符框：特殊颜色标注
     - 橙色框 + "RR"：红色间合并字符
     - 黄色框 + "RG"：红绿合并字符
   - 组件编号：标识分割顺序
   - 总数标注：显示切割出的字符数量

**技术优势**:
- 非破坏性分割：基于像素分布而非形态学操作
- 自适应算法：根据实际字符分布动态调整
- 智能重新分类：确保分割后字符的正确归类
- 智能合并：自动检测并合并被错误分割的字符
- 鲁棒性强：多重备选机制保证分割效果

### 技术细节

#### 预处理模块
- 功能：灰度化 → CLAHE局部对比度增强 → 线性变换调整全局对比度和亮度
- 输入：从 `data/raw/` 目录读取原始图片
- 输出：处理结果保存到 `data/results/preprocessed/` 目录
- 参数化：支持对比度(alpha)和亮度(beta)参数调整

#### 文字切割模块
- 功能：二值化 → 形态学膨胀 → 轮廓检测 → 字符尺寸分析 → 智能分类标注
- 输入：从 `data/results/preprocessed/` 目录读取预处理后的图片
- 输出：标注结果保存到 `data/results/segments/` 目录

##### 基础版本 (`core.py`)
- 分类标准：
  - 红色框：较窄字符（宽度 < 平均值 - 标准差）
  - 绿色框：正常字符（平均值 ± 标准差范围内）
  - 蓝色框：较宽字符（宽度 > 平均值 + 标准差）

##### 增强版本 (`enhanced_core.py`) - 形态学切割功能
- **智能字符分类**:
  - 蓝色(较宽): 宽度≥平均宽度×1.5倍，需要水平分割
  - 紫色(纵向连接): 高度≥平均高度×1.5倍且高宽比>2.5，需要纵向分割
  - 红色(较窄): 宽度<平均宽度-标准差，可能需要合并
  - 绿色(正常): 标准尺寸字符，直接处理
- **形态学切割算法**:
  - 水平腐蚀操作断开纵向连接
  - 连通组件分析自动识别分割后的字符
  - 智能验证确保分割结果合理性
  - 备选均匀分割机制保证鲁棒性
- **可视化标注**:
  - 原始紫色虚线框显示检测到的纵向连接字符
  - 青色实线框显示形态学切割后的各个字符组件
  - 组件编号(1,2,3...)和总数标注(V{数量})
- **改进的统计分析**:
  - 字符宽度和高度的完整统计（平均值、标准差、中位数）
  - 高宽比分析，用于识别异常字符
  - 分类统计：较窄、正常、较宽、纵向连接字符的数量

##### 处理结果示例（demo图片）

**字符统计**：
- 原始字符数：457个
- 合并后字符数：384个
- 平均宽度：51.83 ± 17.18像素
- 平均高度：63.05 ± 37.74像素
- 较窄字符（红色）：12个
- 正常字符（绿色）：407个（包含分割后重新分类的字符）
- 较宽字符（蓝色）：13个
- 纵向连接字符（紫色）：10个，已通过投影分析切割处理

**合并统计**：
- 红红合并：8次（共1轮）
- 红绿合并：65次
- 总合并次数：73次
- 字符减少：73个（457→384）

**处理效果**：
- 多轮红红合并有效处理了相邻的窄字符
- 红绿合并成功将剩余红色字符与绿色字符合并
- 众数尺寸参考提高了合并判断的准确性
- 两阶段策略避免了颜色信息丢失问题